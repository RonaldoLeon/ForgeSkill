{% extends 'usuario.html' %}
{% block title %}Gesti√≥n de Proyecto{% endblock %}

{% block content %}
<div class="header-proyecto">
    <h1>Gesti√≥n: {{ proyecto.nombre }}</h1>
    <div class="progreso-bar">
        <span style="width: {{ proyecto.progreso}}%;"></span>
    </div>
    <p>Progreso General: {{ proyecto.progreso }}%</p>
</div>

<div class="grid-container">
    
    <div class="columna">
        <div class="card">
            <h3>üë• Solicitudes</h3>
            {% if solicitudes.exists %}
            <div style="display:flex;flex-direction:column;gap:12px">
            {% for sol in solicitudes %}
                <div style="padding:12px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;background:#fff">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start">
                        <div>
                            <div style="font-weight:700"><a href="{% url 'public_profile_username' sol.usuario.username %}">{{ sol.usuario.get_full_name|default:sol.usuario.username }}</a></div>
                            <div style="font-size:13px;color:#666;margin-top:4px">@{{ sol.usuario.username }}</div>
                            
                            {% if sol.usuario.perfil.conocimientos %}
                            <div style="font-size:12px;color:#555;margin-top:6px">
                                <strong>Conocimientos:</strong> {{ sol.usuario.perfil.conocimientos }}
                            </div>
                            {% endif %}
                            
                            <div style="margin-top:8px;font-size:12px;color:{% if sol.estado == 'aprobada' %}#4caf50{% elif sol.estado == 'rechazada' %}#f44336{% else %}#ff9800{% endif %};font-weight:600">
                                {{ sol.get_estado_display }}
                            </div>
                        </div>
                        
                        {% if sol.estado == 'pendiente' %}
                        <div style="display:flex;gap:6px;flex-shrink:0">
                            <form method="post" action="{% url 'approve_solicitud' sol.id %}" style="margin:0">{% csrf_token %}
                                <button type="submit" style="padding:6px 12px;background:#4caf50;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600" onclick="return confirm('¬øAprobar?');">‚úì Aprobar</button>
                            </form>
                            <form method="post" action="{% url 'reject_solicitud' sol.id %}" style="margin:0">{% csrf_token %}
                                <button type="submit" style="padding:6px 12px;background:#f44336;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600" onclick="return confirm('¬øRechazar?');">‚úó Rechazar</button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
            </div>
            {% else %}
            <p style="color:#666;text-align:center;padding:20px">No hay solicitudes pendientes.</p>
            {% endif %}
        </div>

        <div class="card" style="margin-top:20px;">
            <h3>Participantes Activos</h3>
            <ul>
                {% for p in participantes %}
                <li>{{ p }} <a href="#" style="font-size:12px;">(Mensaje)</a></li>
                {% endfor %}
            </ul>
            <a href="{% url 'otorgar_insignia' %}" class="btn">üèÜ Otorgar Insignia</a>
        </div>
    </div>

    <div class="columna" style="flex: 2;">
        <div class="card">
            <div style="display:flex; justify-content:space-between;align-items:center;">
                <h3>üìã Tablero de Tareas</h3>
                <a href="{% url 'crear_tarea_proyecto' proyecto.id %}" class="btn" style="padding:8px 14px;font-size:14px">+ Nueva Tarea</a>
            </div>
            
            {% if tareas.exists %}
            <table class="tabla-completa" style="margin-top:12px">
                <thead>
                    <tr>
                        <th>Tarea</th>
                        <th>Asignado a</th>
                        <th>Estado</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in tareas %}
                    <tr>
                        <td>{{ t.titulo }}</td>
                        <td>{% if t.asignado_a %}<a href="{% url 'public_profile_username' t.asignado_a.username %}">{{ t.asignado_a.get_full_name|default:t.asignado_a.username }}</a>{% else %}<span style="color:#999">Sin asignar</span>{% endif %}</td>
                        <td>
                            <span style="padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;background:{% if t.estado == 'completada' %}#c8e6c9{% elif t.estado == 'en_progreso' %}#fff9c4{% else %}#ffccbc{% endif %};color:{% if t.estado == 'completada' %}#2e7d32{% elif t.estado == 'en_progreso' %}#f57f17{% else %}#d84315{% endif %}">{{ t.get_estado_display }}</span>
                        </td>
                        <td><a href="{% url 'editar_tarea' t.id %}" style="padding:4px 8px;background:#00bcd4;color:white;text-decoration:none;border-radius:4px;font-size:12px;font-weight:600">Editar</a></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p style="color:#666;text-align:center;padding:20px;margin-top:12px">No hay tareas en este proyecto.</p>
            {% endif %}
        </div>
    </div>
</div>

<a href="{% url 'foro_proyecto' proyecto.id %}" class="btn" style="background: #673AB7;">
    üí¨ Chat del Equipo
</a>
{% endblock %}
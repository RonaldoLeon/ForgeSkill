{% extends 'usuario.html' %}
{% load user_tags %}

{% block title %}Proyecto{% endblock %}

{% block content %}

<div class="card" style="padding:28px;">
    <div style="display:flex;gap:20px;align-items:flex-start;">
        <div style="flex:0 0 220px;">
            {% if proyecto.imagen %}
                <img src="{{ proyecto.imagen.url }}" alt="{{ proyecto.nombre }}" style="width:100%;border-radius:10px;object-fit:cover;max-height:220px;">
            {% else %}
                <div style="width:100%;height:220px;border-radius:10px;background:linear-gradient(180deg,#eef7f8,#ffffff);display:flex;align-items:center;justify-content:center;color:#0d5470;font-weight:700">Sin imagen</div>
            {% endif %}
            <div style="margin-top:12px;">
                <strong>Encargado:</strong>
                <div style="display:flex;gap:10px;align-items:center;margin-top:6px">
                    {% if proyecto.lider.perfil.foto %}
                        <a href="{% url 'public_profile_username' proyecto.lider.username %}"><img src="{{ proyecto.lider.perfil.foto.url }}" alt="{{ proyecto.lider.username }}" style="width:48px;height:48px;border-radius:50%;object-fit:cover"></a>
                    {% endif %}
                    <div>
                        <div style="font-weight:700">{% user_link proyecto.lider %}</div>
                        <div style="font-size:13px;color:#3f5f66">@<a href="{% url 'public_profile_username' proyecto.lider.username %}">{{ proyecto.lider.username }}</a></div>
                    </div>
                </div>
            </div>
        </div>

        <div style="flex:1;">
            <h1 style="margin-top:0;margin-bottom:6px;color:var(--dark)">{{ proyecto.nombre }}</h1>
            <p style="color:#345a62">{{ proyecto.descripcion|linebreaksbr }}</p>

            <div style="margin-top:12px;display:flex;gap:18px;align-items:center;flex-wrap:wrap">
                <div><strong>Dificultad:</strong> {{ proyecto.dificultad }}</div>
                <div><strong>Participantes:</strong> {{ participantes_count }}{% if proyecto.lider %} (L√≠der incluido){% endif %}</div>
                <div>
                    <strong>L√≠mite:</strong>
                    {% if proyecto.limite_miembros and proyecto.limite_miembros > 0 %}
                        {{ proyecto.limite_miembros }} miembros
                    {% else %}
                        Sin l√≠mite
                    {% endif %}
                </div>
            </div>

            {% if proyecto.habilidades_requeridas or proyecto.lenguajes_programacion %}
            <div style="margin-top:12px;padding:12px;background:#f5f9fc;border-left:4px solid var(--accent);border-radius:4px">
                {% if proyecto.habilidades_requeridas %}
                <div><strong>Habilidades requeridas:</strong> {{ proyecto.habilidades_requeridas }}</div>
                {% endif %}
                {% if proyecto.lenguajes_programacion %}
                <div style="margin-top:4px"><strong>Lenguajes de programaci√≥n:</strong> {{ proyecto.lenguajes_programacion }}</div>
                {% endif %}
            </div>
            {% endif %}

            <div style="margin-top:18px;">
                <strong>Progreso del Proyecto:</strong>
                <div style="margin-top:8px;width:100%;background:rgba(23,41,63,0.06);height:20px;border-radius:12px;overflow:hidden">
                    <div role="progressbar" aria-valuenow="{{ progreso_auto }}" aria-valuemin="0" aria-valuemax="100" style="height:100%;background:linear-gradient(90deg,var(--accent),var(--dark));width:{{ progreso_auto }}%;transition:width 0.3s ease"></div>
                </div>
                <div style="font-size:13px;color:#274b53;margin-top:6px">{{ progreso_auto }}% completado ({{ tareas_completadas }} de {{ tareas_total }} actividades)</div>
            </div>

            <div style="margin-top:18px;display:flex;gap:12px;align-items:center">
                {% if is_leader %}
                    <a class="btn" href="{% url 'gestion_proyecto' proyecto.id %}">Gestionar</a>
                {% endif %}
                {% if request.user.is_staff %}
                    <a class="btn" href="{% url 'lista_insignias' %}">‚öôÔ∏è Gestionar Insignias</a>
                {% endif %}
            </div>

            {% if is_leader %}
                <form method="POST" action="{% url 'set_progreso_proyecto' proyecto.id %}" style="margin-top:18px;display:flex;gap:8px;align-items:center">
                    {% csrf_token %}
                    <label for="progreso_input" style="font-weight:600">Actualizar progreso manual</label>
                    <input id="progreso_input" name="progreso" type="number" min="0" max="100" value="{{ proyecto.progreso }}" style="width:80px;padding:8px;border-radius:8px;border:1px solid rgba(23,41,63,0.08)">
                    <button class="btn" type="submit">Guardar</button>
                </form>
            {% endif %}

        </div>
    </div>
</div>

<!-- Secci√≥n de Actividades/Tareas -->
<div class="card" style="max-width:1100px;margin:28px auto">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
    <h3>üìã Actividades del Proyecto</h3>
    {% if is_leader %}
      <a class="btn" href="{% url 'crear_tarea_proyecto' proyecto.id %}" style="padding:8px 14px;font-size:14px">+ Nueva Actividad</a>
    {% endif %}
  </div>

  {% if tareas.exists %}
    <div style="display:flex;flex-direction:column;gap:10px">
      {% for tarea in tareas %}
        {% with estado_visual=tarea.get_estado_visual %}
        <div style="padding:12px;border:2px solid {% if estado_visual == 'en_retraso' %}#f44336{% elif estado_visual == 'entregado_tarde' %}#ff9800{% else %}#e0e0e0{% endif %};border-radius:8px;background:{% if tarea.estado == 'completada' %}{% if estado_visual == 'entregado_tarde' %}#fff3e0{% else %}#e8f5e9{% endif %}{% elif estado_visual == 'en_retraso' %}#ffebee{% else %}#fff{% endif %}">
          <!-- Encabezado: estado, t√≠tulo y badge de retraso -->
          <div style="display:flex;gap:12px;align-items:flex-start;margin-bottom:8px">
            <form method="POST" action="{% url 'toggle_tarea_estado' tarea.id %}" enctype="multipart/form-data" style="margin:0;flex-shrink:0">
              {% csrf_token %}
              {% if tarea.estado == 'completada' %}
                <select name="estado" disabled style="padding:6px;border-radius:6px;border:1px solid #4caf50;background:#4caf50;color:white;font-weight:600;font-size:12px">
                  <option selected>‚úì Completada</option>
                </select>
              {% else %}
                <select name="estado" onchange="handleTareaEstadoChange(this)" style="padding:6px;border-radius:6px;border:1px solid #ccc;font-size:13px">
                  <option value="pendiente" {% if tarea.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                  <option value="en_progreso" {% if tarea.estado == 'en_progreso' %}selected{% endif %}>En Progreso</option>
                  <option value="completada">‚úì Completada</option>
                </select>
              {% endif %}
              <!-- Input oculto para archivos (aparece solo cuando se selecciona "completada") -->
              <input type="file" id="archivo_{{ tarea.id }}" name="archivo_evidencia" accept=".pdf,.jpg,.jpeg,.png,.zip,.rar" style="display:none;" data-tarea-id="{{ tarea.id }}">
            </form>
            <div style="flex:1">
              <div style="display:flex;gap:8px;align-items:center">
                <div style="font-weight:700;color:#17293f;font-size:15px">{{ tarea.titulo }}</div>
                {% if estado_visual == 'en_retraso' %}
                  <span style="background:#f44336;color:white;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600">üö® EN RETRASO</span>
                {% elif estado_visual == 'entregado_tarde' %}
                  <span style="background:#ff9800;color:white;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600">‚ö†Ô∏è ENTREGADO TARDE</span>
                {% endif %}
              </div>
              {% if tarea.descripcion %}
              <div style="font-size:13px;color:#555;margin-top:4px">{{ tarea.descripcion }}</div>
              {% endif %}
            </div>
            {% if is_leader %}
              <div style="display:flex;gap:6px;flex-shrink:0">
                <a href="{% url 'editar_tarea' tarea.id %}" style="font-size:12px;color:#00bcd4;text-decoration:none;padding:4px 8px;border:1px solid #00bcd4;border-radius:4px">Editar</a>
                <a href="{% url 'eliminar_tarea' tarea.id %}" onclick="return confirm('¬øEliminar?')" style="font-size:12px;color:#f44336;text-decoration:none;padding:4px 8px;border:1px solid #f44336;border-radius:4px">Eliminar</a>
              </div>
            {% endif %}
          </div>

          <!-- Informaci√≥n: asignaci√≥n, entrega, completado, evidencia -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;font-size:12px;margin-top:8px;padding-top:8px;border-top:1px solid rgba(0,0,0,0.08)">
            <!-- Asignaci√≥n -->
            {% if tarea.asignado_a %}
            <div style="background:rgba(0,0,0,0.02);padding:8px;border-radius:6px">
              <div style="font-weight:600;color:#17293f;margin-bottom:2px">üìå Asignado a</div>
              <a href="{% url 'public_profile_username' tarea.asignado_a.username %}" style="color:#00bcd4;text-decoration:none">{{ tarea.asignado_a.get_full_name|default:tarea.asignado_a.username }}</a>
              <div style="font-size:11px;color:#999;margin-top:2px">{{ tarea.fecha_asignacion|date:"d/m/Y H:i" }}</div>
            </div>
            {% endif %}
            
            <!-- Fecha de entrega -->
            <div style="background:rgba(0,0,0,0.02);padding:8px;border-radius:6px;border-left:3px solid {% if estado_visual == 'en_retraso' %}#f44336{% elif estado_visual == 'entregado_tarde' %}#ff9800{% else %}#4caf50{% endif %}">
              <div style="font-weight:600;color:#17293f;margin-bottom:2px">üìÖ Fecha de entrega</div>
              <div style="color:{% if estado_visual == 'en_retraso' %}#f44336{% elif estado_visual == 'entregado_tarde' %}#ff9800{% else %}#333{% endif %};font-weight:600">
                {{ tarea.fecha_entrega|date:"d/m/Y H:i" }}
              </div>
              {% if tarea.estado != 'completada' and estado_visual == 'a_tiempo' %}
                <div style="font-size:11px;color:#4caf50;margin-top:2px">‚è±Ô∏è {{ tarea.get_dias_restantes }} d√≠as restantes</div>
              {% endif %}
            </div>
            
            <!-- Entrega -->
            {% if tarea.estado == 'completada' and tarea.completado_por %}
            <div style="background:rgba(76,175,80,0.08);padding:8px;border-radius:6px;border-left:3px solid #4caf50">
              <div style="font-weight:600;color:#17293f;margin-bottom:2px">‚úì Entregado por</div>
              <a href="{% url 'public_profile_username' tarea.completado_por.username %}" style="color:#4caf50;text-decoration:none;font-weight:600">{{ tarea.completado_por.get_full_name|default:tarea.completado_por.username }}</a>
              <div style="font-size:11px;color:#999;margin-top:2px">{{ tarea.fecha_completado|date:"d/m/Y H:i" }}</div>
            </div>
            {% endif %}
            
            <!-- Evidencia -->
            {% if tarea.estado == 'completada' and tarea.archivo_evidencia %}
            <div style="background:rgba(0,150,136,0.08);padding:8px;border-radius:6px;border-left:3px solid #009688">
              <div style="font-weight:600;color:#17293f;margin-bottom:2px">üìé Evidencia</div>
              <a href="{{ tarea.archivo_evidencia.url }}" target="_blank" style="color:#009688;text-decoration:none;font-weight:600;display:inline-flex;gap:4px;align-items:center">
                üì• Ver archivo
              </a>
            </div>
            {% endif %}
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    </div>
  {% else %}
    <div style="text-align:center;padding:32px;color:#666">
      <p>No hay actividades en este proyecto a√∫n.</p>
      {% if is_leader %}
        <a class="btn" href="{% url 'crear_tarea_proyecto' proyecto.id %}">Crear primera actividad</a>
      {% endif %}
    </div>
  {% endif %}

  <!-- Script para manejar la carga de archivo cuando se marca como completada -->
  <script>
    function handleTareaEstadoChange(selectElement) {
      if (selectElement.value === 'completada') {
        // Extraer el ID de la tarea del atributo data del form
        const form = selectElement.closest('form');
        const fileInput = form.querySelector('input[type="file"]');
        fileInput.click();
        
        // Cuando se selecciona un archivo, enviar el form
        fileInput.addEventListener('change', function() {
          if (this.files.length > 0) {
            form.submit();
          } else {
            // Si cancela, resetear el select
            selectElement.value = selectElement.querySelector('option[selected]').value || 'pendiente';
          }
        }, { once: true });
      } else {
        // Para otros estados, simplemente enviar el form
        selectElement.closest('form').submit();
      }
    }
  </script>
</div>

<!-- Bot√≥n de Chat Grupal (visible para todos) -->
<div style="max-width:1100px;margin:18px auto">
  <a class="btn" href="{% url 'foro_proyecto' proyecto.id %}" style="display:inline-flex;gap:8px;align-items:center;padding:12px 20px;background:#7c3aed;color:white;text-decoration:none;border-radius:8px;font-weight:600">
    üí¨ Chat del Equipo
  </a>
</div>
 
<!-- Insignias: cat√°logo y otorgadas (visibles en la ficha del proyecto) -->
        <div style="max-width:1100px;margin:28px auto;display:grid;grid-template-columns:1fr 1fr;gap:18px">
            <div class="card">
                <h3>üèÜ Insignias disponibles</h3>
                <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
                    {% for ins in insignias_catalogo %}
                        <div style="width:180px;border:1px solid rgba(0,0,0,0.04);padding:10px;border-radius:8px;text-align:center;background:#fff">
                            <div style="font-size:32px">{% if ins.imagen %}<img src="{{ ins.imagen.url }}" style="width:48px;height:48px;object-fit:cover">{% else %}üèÖ{% endif %}</div>
                            <div style="font-weight:700;margin-top:8px">{{ ins.nombre }}</div>
                            {% if ins.descripcion %}<div style="font-size:13px;color:#667">{{ ins.descripcion }}</div>{% endif %}
                            <div style="margin-top:8px;color:#0d7">+{{ ins.puntos }} pts</div>
                        </div>
                    {% empty %}
                        <div style="color:#666">No hay insignias definidas.</div>
                    {% endfor %}
                </div>
            </div>

            <div class="card">
                <h3>üèÖ Insignias otorgadas a participantes</h3>
                <div style="margin-top:12px">
                    {% if insignias_otorgadas.exists %}
                        <ul style="list-style:none;padding-left:0;margin:0">
                            {% for io in insignias_otorgadas %}
                                <li style="padding:8px 0;border-bottom:1px dashed rgba(0,0,0,0.04)">
                                    <strong><a href="{% url 'public_profile_username' io.usuario.username %}">{{ io.usuario.get_full_name|default:io.usuario.username }}</a></strong>
                                    ‚Äî <em style="color:#274b53">{{ io.insignia.nombre }}</em>
                                    <div style="font-size:12px;color:#666">{{ io.fecha|date:"d/m/Y H:i" }}{% if io.motivo %} ‚Äî {{ io.motivo|truncatechars:70 }}{% endif %}</div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div>No se han otorgado insignias a participantes de este proyecto.</div>
                    {% endif %}
                </div>
            </div>
        </div>

<!-- Historial de Actividad -->
<div class="card" style="max-width:1100px;margin:28px auto">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <h3>üïò Historial de Actividad</h3>
    </div>

    {% if actividad %}
        <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px">
            {% for ev in actividad %}
                <li style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);background:#fff;display:flex;gap:12px;align-items:flex-start">
                    <div style="min-width:44px;text-align:center;color:#666;font-size:13px">
                        {{ ev.fecha|date:"d/m H:i" }}
                    </div>
                    <div style="flex:1">
                        <div style="font-weight:700;color:#17293f">{{ ev.accion }}</div>
                        <div style="font-size:13px;color:#445">{{ ev.detalle }}</div>
                        <div style="font-size:12px;color:#888;margin-top:6px">Por: {% if ev.usuario %}<a href="{% url 'public_profile_username' ev.usuario.username %}">{{ ev.usuario.get_full_name|default:ev.usuario.username }}</a>{% else %}Sistema{% endif %}</div>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <div style="padding:20px;color:#666">No hay actividad registrada en este proyecto.</div>
    {% endif %}
</div>
{% endblock %}
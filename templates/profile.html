{% extends 'usuario.html' %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'profile.css' %}">

<div class="card">

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <h2 style="margin:0">Mi Perfil</h2>
        <button id="btn-editar" class="boton" onclick="habilitarEdicion()" style="display:none;background:#ff9800">‚úèÔ∏è Editar Perfil</button>
        <button id="btn-cancelar" class="boton" onclick="cancelarEdicion()" style="display:none;background:#999">‚úï Cancelar</button>
    </div>

    <!-- VISTA: Datos est√°ticos (por defecto visible) -->
    <div id="vista-estatica">
        <!-- Foto -->
        {% if perfil.foto %}
            <img src="{{ perfil.foto.url }}" class="foto" style="max-width:150px;border-radius:8px;margin-bottom:20px">
        {% else %}
            <div style="width:150px;height:150px;background:#f0f0f0;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999;margin-bottom:20px">Sin foto</div>
        {% endif %}

        <!-- Informaci√≥n personal -->
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:20px">
            <!-- Nombre completo -->
            <div style="padding:12px;background:#f5f5f5;border-radius:6px">
                <div style="font-size:12px;color:#666;font-weight:600;margin-bottom:4px">NOMBRE COMPLETO</div>
                <div style="font-weight:600;color:#17293f">{{ perfil.user.get_full_name|default:"No especificado" }}</div>
            </div>

            <!-- Email -->
            <div style="padding:12px;background:#f5f5f5;border-radius:6px">
                <div style="font-size:12px;color:#666;font-weight:600;margin-bottom:4px">EMAIL</div>
                <div style="font-weight:600;color:#17293f">{{ perfil.user.email }}</div>
            </div>

            <!-- √Årea de trabajo -->
            <div style="padding:12px;background:#f5f5f5;border-radius:6px">
                <div style="font-size:12px;color:#666;font-weight:600;margin-bottom:4px">√ÅREA DE TRABAJO</div>
                <div style="font-weight:600;color:#17293f">{{ perfil.area_trabajo|default:"No especificada" }}</div>
            </div>

            <!-- Ciudad -->
            <div style="padding:12px;background:#f5f5f5;border-radius:6px">
                <div style="font-size:12px;color:#666;font-weight:600;margin-bottom:4px">CIUDAD</div>
                <div style="font-weight:600;color:#17293f">{{ perfil.ciudad|default:"No especificada" }}</div>
            </div>

            <!-- Tel√©fono -->
            <div style="padding:12px;background:#f5f5f5;border-radius:6px">
                <div style="font-size:12px;color:#666;font-weight:600;margin-bottom:4px">TEL√âFONO</div>
                <div style="font-weight:600;color:#17293f">{{ perfil.telefono|default:"No especificado" }}</div>
            </div>
        </div>

        <!-- Biograf√≠a -->
        {% if perfil.bio %}
        <div style="margin-bottom:15px">
            <h3>Biograf√≠a</h3>
            <p style="color:#555;line-height:1.6">{{ perfil.bio|linebreaks }}</p>
        </div>
        {% endif %}

        <!-- Conocimientos -->
        <div style="margin-bottom:15px">
            <h3>Conocimientos</h3>
            {% if perfil.conocimientos %}
            <p style="color:#555;line-height:1.6">{{ perfil.conocimientos|linebreaks }}</p>
            {% else %}
            <p style="color:#999;font-style:italic">No has agregado conocimientos a√∫n.</p>
            {% endif %}
        </div>

        <!-- Nivel de Estudio -->
        {% if perfil.nivel_estudio %}
        <div style="margin-bottom:15px">
            <h3>Nivel de Estudio</h3>
            <p style="color:#555;line-height:1.6">{{ perfil.nivel_estudio|linebreaks }}</p>
        </div>
        {% endif %}

        <!-- Idiomas -->
        {% if perfil.idiomas %}
        <div style="margin-bottom:15px">
            <h3>Idiomas</h3>
            <p style="color:#555;line-height:1.6">{{ perfil.idiomas|linebreaks }}</p>
        </div>
        {% endif %}

        <hr>

        <!-- Bot√≥n Editar visible en vista est√°tica -->
        <button id="btn-editar-principal" class="boton" onclick="habilitarEdicion()" style="background:#00bcd4;margin-bottom:15px">‚úèÔ∏è Editar mi perfil</button>
    </div>

    <!-- EDICI√ìN: Formulario (oculto por defecto) -->
    <div id="vista-edicion" style="display:none">
        <form id="perfil-form" method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Foto -->
            <div style="margin-bottom:15px">
                <label style="font-weight:600;color:#17293f">Foto de perfil</label>
                {{ form.foto }}
                {% if form.foto.errors %}<span style="color:red">{{ form.foto.errors }}</span>{% endif %}
            </div>

            <!-- Nombre completo (readonly) -->
            <div style="margin-bottom:15px;padding:12px;background:#f5f5f5;border-radius:6px">
                <strong>Nombre de usuario:</strong> {{ perfil.user.username }}
            </div>

            <!-- Bio -->
            <div style="margin-bottom:15px">
                <label style="font-weight:600;color:#17293f">Biograf√≠a</label>
                {{ form.bio }}
                {% if form.bio.errors %}<span style="color:red">{{ form.bio.errors }}</span>{% endif %}
            </div>

            <!-- √Årea de trabajo -->
            <div style="margin-bottom:15px">
                <label style="font-weight:600;color:#17293f">√Årea de trabajo</label>
                {{ form.area_trabajo }}
                {% if form.area_trabajo.errors %}<span style="color:red">{{ form.area_trabajo.errors }}</span>{% endif %}
            </div>

            <!-- Tel√©fono -->
            <div style="margin-bottom:15px">
                <label style="font-weight:600;color:#17293f">Tel√©fono</label>
                {{ form.telefono }}
                {% if form.telefono.errors %}<span style="color:red">{{ form.telefono.errors }}</span>{% endif %}
            </div>

            <!-- Ciudad -->
            <div style="margin-bottom:15px">
                <label style="font-weight:600;color:#17293f">Ciudad</label>
                {{ form.ciudad }}
                {% if form.ciudad.errors %}<span style="color:red">{{ form.ciudad.errors }}</span>{% endif %}
            </div>

            <!-- Nivel de estudio -->
            <div style="margin-bottom:15px">
                <label style="font-weight:600;color:#17293f">Nivel de estudio</label>
                <small style="color:#666;display:block;margin-bottom:5px">Ej: Licenciatura en Ingenier√≠a, Diplomado en Python</small>
                {{ form.nivel_estudio }}
                {% if form.nivel_estudio.errors %}<span style="color:red">{{ form.nivel_estudio.errors }}</span>{% endif %}
            </div>

            <!-- Idiomas -->
            <div style="margin-bottom:15px">
                <label style="font-weight:600;color:#17293f">Idiomas</label>
                <small style="color:#666;display:block;margin-bottom:5px">Ej: Espa√±ol (Nativo), Ingl√©s (B2)</small>
                {{ form.idiomas }}
                {% if form.idiomas.errors %}<span style="color:red">{{ form.idiomas.errors }}</span>{% endif %}
            </div>

            <!-- Conocimientos -->
            <div style="margin-bottom:15px">
                <label style="font-weight:600;color:#17293f">Conocimientos</label>
                <small style="color:#666;display:block;margin-bottom:5px">Ej: Python, JavaScript, Django, React, SQL</small>
                {{ form.conocimientos }}
                {% if form.conocimientos.errors %}<span style="color:red">{{ form.conocimientos.errors }}</span>{% endif %}
            </div>

            <!-- Botones de acci√≥n -->
            <div style="display:flex;gap:8px;margin-top:20px">
                <button type="submit" class="boton" style="flex:1;background:#4caf50">‚úì Guardar cambios</button>
                <button type="button" class="boton" onclick="cancelarEdicion()" style="flex:1;background:#999">‚úï Cancelar</button>
            </div>
        </form>
    </div>

    <hr>

    <!-- Experiencia -->
    <h3>Experiencia Acumulada</h3>
    <a class="boton" href="/perfil/experiencia/agregar/" style="margin-bottom:15px">+ Agregar experiencia</a>

    <ul>
    {% for e in experiencias %}
        <li style="margin-bottom:10px;padding:10px;background:#f5f5f5;border-radius:6px">
            <strong>{{ e.proyecto }}</strong> ‚Äî {{ e.rol }} ({{ e.fecha|date:"Y" }})<br>
            <small style="color:#666">{{ e.descripcion }}</small>
        </li>
    {% empty %}
        <p style="color:#999">No tienes experiencia registrada.</p>
    {% endfor %}
    </ul>

    <hr>

    <!-- Acciones finales -->
    <div style="display:flex;gap:8px;align-items:center;margin-top:12px;margin-bottom:14px;">
        <a href="/perfil/pdf/" class="boton" style="flex:1;background:#673ab7;text-decoration:none;text-align:center">üìÑ Generar PDF CV</a>
        <form method="POST" action="{% url 'logout' %}" style="margin:0;flex:1">
            {% csrf_token %}
            <button type="submit" class="boton" style="background:#c94b4b;border:none;width:100%">üö™ Cerrar sesi√≥n</button>
        </form>
    </div>

</div>

<style>
    .input-estilo {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        margin-top: 5px;
        font-family: inherit;
        font-size: 14px;
    }

    .boton {
        padding: 10px 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .boton:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
</style>

<script>
    function habilitarEdicion() {
        // Mostrar formulario de edici√≥n
        document.getElementById('vista-edicion').style.display = 'block';
        document.getElementById('vista-estatica').style.display = 'none';
        document.getElementById('btn-editar').style.display = 'inline-block';
        document.getElementById('btn-cancelar').style.display = 'inline-block';
        // Scroll al formulario
        document.getElementById('vista-edicion').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelarEdicion() {
        // Volver a vista est√°tica sin guardar cambios
        document.getElementById('vista-edicion').style.display = 'none';
        document.getElementById('vista-estatica').style.display = 'block';
        document.getElementById('btn-editar').style.display = 'none';
        document.getElementById('btn-cancelar').style.display = 'none';
        // Recargar el formulario para descartar cambios
        document.getElementById('perfil-form').reset();
    }
</script>

{% endblock %}
